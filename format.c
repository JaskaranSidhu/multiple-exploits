#include <stdlib.h> // malloc, free, system
#include <string.h> // strchr, strlen
#include <stdio.h>  // printf, snprintf, fflush

int main(int argc, char ** argv)
{
    if (argc < 2)
    {
        printf("Usage: %s message\n", argv[0]);
        return 1;
    }
    const char * message = argv[1];

    char * forbidden = malloc(11 * sizeof(char));
    forbidden[0] = '&';
    forbidden[1] = '$';
    forbidden[2] = '/';
    forbidden[3] = '(';
    forbidden[4] = ')';
    forbidden[5] = ';';
    forbidden[6] = '|';
    forbidden[7] = '>';
    forbidden[8] = '<';
    forbidden[9] = '\\';
    forbidden[10] = '#';

    printf("Checking \"");
    printf(message);
    printf("\" for forbidden chars...");

    for (int i = 0; i < 11; ++i)
    {
        if (strchr(message, forbidden[i]))
        {
            printf("ABORT: found '%c'\n", forbidden[i]);
            free(forbidden);
            return 1;
        }
    }
    printf("looks safe to me!\n");

    const char * prefix = "/bin/echo";
    printf(" -> Invoking %s: ", prefix);
    fflush(stdout);
    char echocmd[strlen(prefix)+1+strlen(message)+1];
    snprintf(echocmd, sizeof(echocmd), "%s %s", prefix, message);
    system(echocmd);

    free(forbidden);

    return 0;
}